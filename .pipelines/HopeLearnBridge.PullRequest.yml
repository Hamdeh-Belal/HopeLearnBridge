name: $(TeamProject)_$(Build.DefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:r)

trigger:
  none

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  backendSolutionpath: 'src/backend/HopeLearnBridge.sln'
  frontendPath: 'src/frontend'

stages:
- stage: BackendBuild
  jobs:
  - job: BuildBackend
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.0.303'

    - task: DotNetCoreCLI@2
      inputs:
        command: restore
        projects: '$(backendSolutionpath)'

    - task: DotNetCoreCLI@2
      inputs:
        command: build
        projects: '$(backendSolutionpath)'
        arguments: '--configuration $(buildConfiguration) --no-restore'

- stage: FrontendBuild
  jobs:
  - job: BuildFrontend
    steps:
    - task: UseNode@1
      inputs:
        version: '20.16.0'
      displayName: 'Install Node.js'

    - task: PowerShell@2
      displayName: 'Install pnpm'
      inputs:
        targetType: 'inline'
        workingDirectory: '$(frontendPath)'
        script: |
          corepack enable
          corepack prepare pnpm@20.16.0 --activate
          pnpm config set store-dir $(Pipeline.Workspace)/.pnpm-store

    - task: PowerShell@2
      displayName: 'Install frontend packages'
      inputs:
        targetType: 'inline'
        workingDirectory: '$(frontendPath)'
        script: |
          pnpm install

    - task: PowerShell@2
      displayName: 'Linting'
      inputs:
        targetType: 'inline'
        workingDirectory: '$(frontendPath)'
        script: |
          pnpm run lint

    - task: PowerShell@2
      displayName: 'Building frontend repo'
      inputs:
        targetType: 'inline'
        workingDirectory: '$(frontendPath)'
        script: |
          pnpm run build:dev

    - bash: az bicep build --file infra/biceps/main.bicep --outfile infra/mainTemplate.json
      displayName: "Building Biceps"